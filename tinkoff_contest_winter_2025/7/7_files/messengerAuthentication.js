(()=>{"use strict";var e,t,n,s,o,r,i,a,d,u,c,p,l;!function(e){e.InitTmsg="initTmsg",e.OpenMessenger="openMessenger",e.ToggleMessenger="toggleMessenger",e.CloseMessenger="closeMessenger"}(e||(e={})),function(e){e.Sso="sso",e.Webim="webim"}(t||(t={})),function(e){e.Guest="guest",e.Authorized="authorized"}(n||(n={})),function(e){e.OnMessengerFail="ON_MESSENGER_FAIL",e.OnMessengerInited="ON_MESSENGER_INITED",e.OnMessengerClose="ON_MESSENGER_CLOSE",e.OnMessengerOpen="ON_MESSENGER_OPEN",e.OnUnreadIndicatorChanged="ON_UNREAD_INDICATOR_CHANGED",e.OnUnreadMessagesCountChanged="ON_UNREAD_MESSAGES_COUNT_CHANGED",e.OnMessengerUpdateSession="ON_MESSENGER_UPDATE_SESSION",e.OnMessengerScreenChanged="ON_MESSENGER_SCREEN_CHANGED"}(s||(s={})),function(e){e.Conversation="conversation",e.Error="error",e.ConversationsList="conversations-list",e.WelcomeForm="welcome-form",e.ArchiveList="archive-list",e.WidgetLongVersion="widget-long-version",e.DiscussionAbout="discussion-about",e.DiscussionEdit="discussion-edit",e.DiscussionUserEdit="discussion-user-edit",e.ValidationInput="validation-input"}(o||(o={})),function(e){e.Auto="auto",e.Visible="visible",e.Hidden="hidden",e.SingleConversationOnly="singleConversationOnly"}(r||(r={})),function(e){e.IframeInitSuccess="iframeInitSuccess",e.IframeLoad="iframeLoad"}(i||(i={})),function(e){e.Resize="resize"}(a||(a={})),function(e){e.MessengerOpenedStatus="messengerOpenedStatus",e.UpdateCompanyId="update-companyId",e.UpdateLocation="update-location",e.TmsgUserInfo="tmsg-userInfo",e.UpdateApplications="update-applications",e.UpdateUnreadCounter="updateUnreadCounter",e.UpdateUnreadMessagesCount="updateUnreadMessagesCount",e.FocusEvent="focus-event",e.PushNotification="push-notification",e.OpenConversationById="open-conversation-by-id",e.OpenConversationByAppId="open-conversation-by-app-id",e.OpenSupportConversation="open-support-conversation",e.TmsgOpenDraft="tmsg-openDraft",e.PlatformResize="platformResize",e.TmsgSendMessage="tmsg-send-message",e.TmsgWidgetTitle="tmsg-widget-title",e.TmsgWidgetSubtitle="tmsg-widget-subtitle",e.TmsgWidgetAvatar="tmsg-widget-avatar",e.TmsgColorConfig="tmsg-color-config",e.TmsgWelcomeFormConfig="tmsg-welcome-form-config",e.TmsgCloseButtonVisibility="tmsg-close-button-visibility",e.TmsgInit="tmsg-init",e.TmsgClose="tmsg-close",e.TmsgUpdateSession="tmsg-update-session",e.TmsgWelcomeFormDisplayStatus="tmsg-welcome-form-display-status",e.TmsgWelcomeFormScreenChanged="tmsg-welcome-form-screen-changed",e.TmsgScreenChanged="tmsg-screen-changed",e.UpdateLocale="tmsg-update-locale",e.TmsgPlatformUserResponse="tmsg-platform-user-response",e.TmsgPlatformUserRequest="tmsg-platform-user-request",e.TmsgUrlResponse="tmsg-url-response",e.TmsgUrlRequest="tmsg-url-request"}(d||(d={})),function(e){e.Notify="NOTIFY",e.RecalculateActiveTab="RECALCULATE_ACTIVE_TAB"}(u||(u={})),function(e){e.Desktop="desktop",e.WebMobile="web_mobile",e.PWA="pwa",e.Unknown="unknown"}(c||(c={})),function(e){e.Name="name",e.Phone="phone",e.Email="email",e.Date="date"}(p||(p={})),function(e){e.First="first",e.Second="second"}(l||(l={}));var m;!function(e){e.Bank="bank",e.Invest="invest",e.HrRabota="hr_rabota",e.EmployeeSupport="employee_support",e.Kids="kids",e.Default="default"}(m||(m={}));const h=["app=bank","app=invest"],f="messengerInitEvent",g=1800;function w(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{d(s.next(e))}catch(e){r(e)}}function a(e){try{d(s.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}Object.create;Object.create;"function"==typeof SuppressedError&&SuppressedError;const v="messengerStatistEvent";function E(e,t){const n=new CustomEvent(v,{detail:{event:e,parameters:t}});window.dispatchEvent(n)}const y=1e3,S=6e4;let C=!1,T=!1,I=null,R=null,O=null,b=[];function M({detail:e}){b.push(e)}function U(){window.removeEventListener(v,M),b.forEach((({event:e,parameters:t})=>{E(e,t)})),b=[],C&&N(),T=!0}function L(e,t){C=!0,R=e,O=t?function(e){return e instanceof Error?e:"string"==typeof e?new Error(e):new Error("Unknown error")}(t):null,e&&function(e){I&&clearTimeout(I);I=setTimeout((()=>{clearTimeout(I),window.authorizeMessenger()}),e*y-S>0?e*y-S:0)}((null==e?void 0:e.expires_in)||g),T&&N()}function N(){const e=new CustomEvent(f,{detail:O||R});window.dispatchEvent(e)}class A{constructor(e,t){this.url=e,this.method=t,this.httpRequest=new XMLHttpRequest,this.headers={}}static get(e){return new A(e,"GET")}static post(e){return new A(e,"POST")}static put(e){return new A(e,"PUT")}static delete(e){return new A(e,"DELETE")}send(e,t,n=[401]){let s;const{httpRequest:o,method:r}=this,i=new Promise(((e,t)=>{o.addEventListener("load",(o=>{const{status:r,response:i}=o.target,a=this.parseResponse(i);-1!==n.indexOf(r)||a&&!1===a.success||a.errorCode?t(a):(s&&clearTimeout(s),e(a))})),o.addEventListener("error",(e=>{const{response:n}=e.target;t(this.parseResponse(n)||new Error("Unknown error occurred."))}))}));return o.open(r,this.getRequestUrl(e),!0),this.applyHeaders(),o.send(e),t&&(s=setTimeout((()=>{const e=new CustomEvent("error");o.dispatchEvent(e),o.abort()}),t)),i}sendAsJSON(e){return this.setHeaders("Content-Type","application/json").send(JSON.stringify(e))}sendAsFormUrlEncoded(e){const t=new URLSearchParams(e);return this.setHeaders("Content-Type","application/x-www-form-urlencoded").send(t.toString())}withCredentials(e){return this.httpRequest.withCredentials=e,this}setHeaders(e,t){return this.headers[e]=t,this}parseResponse(e){try{return JSON.parse(e)}catch(t){return e}}getRequestUrl(e){if("GET"===this.method){const t=!e||Object.keys(e).length<1?"":`?${new URLSearchParams(e)}`;return`${this.url}${t}`}return this.url}applyHeaders(){for(const e in this.headers)if(this.headers.hasOwnProperty(e)){const t=this.headers[e];this.httpRequest.setRequestHeader(e,t)}}}function _(){return window.TCS||{}}function D(e){return`/app/${P()}/${e}`}function P(){var e;return _().appId||(null===(e=_().appName)||void 0===e?void 0:e.match("app[/=](.*)")[1])}const k="api/v1/session/validate",q="sessionID";function H(e=D(k),t){return w(this,void 0,void 0,(function*(){const n=A.get(e).withCredentials(!0),s=_().authZone;t&&n.setHeaders(q,t);const o=P(),r=performance.now();E("auth.sso.validate.init",{appId:o});try{const{result:e}=yield n.send(s?{currentZone:s}:void 0);return E("auth.sso.validate.success",{appId:o,duration:Math.round(performance.now()-r)}),e}catch(e){const{errorCode:t,errorMessage:n}=e,s=n.toLowerCase().includes("invalid auth system")?"invalid auth system":n;throw E("auth.sso.validate.error",{appId:o,duration:Math.round(performance.now()-r),errorCode:t,errorMessage:s}),e}}))}function z(e=location.search){const t=new URLSearchParams(e);return{authToken:t.get("authToken"),code:t.get("code"),state:t.get("state"),sessionState:t.get("session_state")}}const W="api/v1/session/authorize";const G={maxTries:3,delayStep:5e3};function x(e,t=G,n=0){return w(this,void 0,void 0,(function*(){const s=n<t.maxTries-1;try{return yield e()}catch(o){if(s)return yield function(e=0){return new Promise((t=>{setTimeout(t,e)}))}(t.delayStep+t.delayStep*n),x(e,t,n+1);throw o}}))}const F="api/v1/session/ssoLogin";function B(e){const t=document.getElementById(e);t&&t.remove()}const $="authErrorResponse",j="authParamsResponse";function V(e,t){const n=function(e){const t=document.createElement("iframe");return t.style.width="0px",t.style.height="0px",t.style.position="absolute",t.style.left="-4000px",t.src=e,t}(e);var s;n.id=t,s=n,document.body?document.body.appendChild(s):document.addEventListener("DOMContentLoaded",(()=>{document.body.appendChild(s)}))}const J="/common/auth/checkAuth.html";function Z(e){return w(this,void 0,void 0,(function*(){const{code:t,state:n}=e;if(!t||!n)throw new Error("Invalid auth data");try{L(yield function(e,t=D(F)){return w(this,void 0,void 0,(function*(){const n=P();try{return yield x((()=>w(this,void 0,void 0,(function*(){const s=performance.now();E("auth.sso.ssoLogin.init",{appId:n});try{const{result:o}=yield A.get(t).withCredentials(!0).send(e);return E("auth.sso.ssoLogin.success",{appId:n,duration:Math.round(performance.now()-s)}),o}catch(e){throw E("auth.sso.ssoLogin.error",{appId:n,duration:Math.round(performance.now()-s)}),e}}))))}catch(e){throw E("auth.sso.ssoLogin.errorAfterRetries",{appId:n}),e}}))}(e))}catch(e){L(null,e)}}))}function K(){return w(this,void 0,void 0,(function*(){const e={returnTo:location.origin+J,prompt:"none"},t=performance.now(),n=P();E("auth.sso.authorize.init",{appId:n});try{const{redirectUrl:s}=yield function(e){return A.get(D(W)).setHeaders("Accept","application/json").withCredentials(!0).send(e)}(e);E("auth.sso.authorize.success",{appId:n,duration:Math.round(performance.now()-t)});const[,o]=s.split("?"),{state:r}=z(o),i=function(e){const[t,n]=e.split("?"),s=new URLSearchParams(n);return s.delete("display"),s.delete("response_mode"),s.set("redirect_on_error","true"),`${t}?${s.toString()}`}(s),a=Date.now().toString();!function(e,t,n=z,s){window.addEventListener("message",(o=>{if("object"!=typeof o.data)return;const{messageCode:r,data:i}=o.data;if(!i||!r)return;const{code:a,state:d}=n(i);r===j&&d===e&&(t({code:a,state:d}),B(s))}))}(r,Z,void 0,a),function(e,t,n){window.addEventListener("message",(s=>{if("object"!=typeof s.data)return;const{messageCode:o}=s.data,r=s.data.data;o===$&&r.state===e&&(t(r.error),B(n))}))}(r,L,a),V(i,a)}catch(e){throw E("auth.sso.authorize.error",{appId:n,duration:Math.round(performance.now()-t)}),e}}))}function X(){return w(this,void 0,void 0,(function*(){window.authorizeMessenger=function(){return w(this,void 0,void 0,(function*(){yield K()}))};try{const e=yield H();e?L(e):yield K()}catch(e){yield K()}}))}function Y(e,t){return w(this,void 0,void 0,(function*(){const n=t||{},s=A.post(`/app/${e}/api/v1/session/issueTokenByWEBIMWeb`);try{return yield x((()=>w(this,void 0,void 0,(function*(){const t=performance.now();E("auth.webim.init",{appId:e});try{const{result:o}=yield s.sendAsJSON(n);return E("auth.webim.success",{appId:e,duration:Math.round(performance.now()-t)}),o}catch(n){throw E("auth.webim.error",{appId:e,duration:Math.round(performance.now()-t)}),n}}))))}catch(t){throw E("auth.webim.errorAfterRetries",{appId:e}),t}}))}function Q(e){window.addEventListener("message",(function t(n){return w(this,void 0,void 0,(function*(){if(n.data&&n.data.messageCode===d.TmsgPlatformUserResponse){window.authorizeMessenger=function(){return w(this,void 0,void 0,(function*(){yield Y(e,n.data.data)}))};try{L(yield Y(e,n.data.data))}catch(e){L(null,e)}window.removeEventListener("message",t)}}))})),window.parent.postMessage({messageCode:d.TmsgPlatformUserRequest},"*")}function ee(e){switch(e){case m.Bank:case m.Invest:case m.HrRabota:case m.EmployeeSupport:case m.Kids:Q(e);break;case m.Default:!function(){if(window.parent!==window)return window.addEventListener("message",(function e(t){if(t.data&&t.data.messageCode===d.TmsgUrlResponse){const n=t.data.data.match("app=[a-zA-Z]+"),s=null==n?void 0:n[0];-1!==h.indexOf(s)?Q(s):X(),window.removeEventListener("message",e)}})),void window.parent.postMessage({messageCode:d.TmsgUrlRequest},"*");X()}();break;default:X()}}window.addEventListener("ssoAuthDataRequest",U),window.addEventListener(v,M),function(){const e=P(),n=_().authSystem||null;if(n)return E("auth.init",{appId:e,method:"authSystem"}),void function(e,n){switch(e){case t.Sso:X();break;case t.Webim:Q(n);break;default:ee(n)}}(n,e);E("auth.init",{appId:e,method:"appId"}),ee(e)}()})();